<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<canvas id="graficoVendasDia" height="150"></canvas>

<script>
let graficoDia = null;

const avatarImgDia = new Image();
avatarImgDia.src = "/static/img/user.png";

// Plugin: avatar + nome (SEM FUNDO)
const pluginAvatarDia = {
    id: "avatarDia",
    afterDatasetsDraw(chart) {
        const ctx = chart.ctx;
        const meta = chart.getDatasetMeta(0);

        meta.data.forEach((bar, index) => {
            const x = bar.x;
            const y = bar.y - 35;
            const radius = 17;

            // avatar redondo
            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y - 10, radius, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();
            ctx.drawImage(avatarImgDia, x - radius, y - radius - 10, radius * 2, radius * 2);
            ctx.restore();

            // nome do garçom
            ctx.save();
            ctx.fillStyle = "#333";
            ctx.font = "bold 12px Arial";
            ctx.textAlign = "center";
            ctx.fillText(chart.data.labels[index], x, y - 30);
            ctx.restore();
        });
    }
};

Chart.register(pluginAvatarDia);

async function carregarGraficoDia() {
    const dataEscolhida = document.getElementById("data-dia")?.value;
    let url = "http://192.168.0.17:5002/vendas_valor_por_funcionario";
    if (dataEscolhida) url += `?date=${dataEscolhida}`;

    const res = await fetch(url);
    const dados = await res.json();

    const labels = dados.labels;
    const totals = dados.totals ?? [];

    const ctx = document.getElementById("graficoVendasDia").getContext("2d");

    // gradiente suave
    const grad = ctx.createLinearGradient(0, 0, 0, 300);
    grad.addColorStop(0, "rgba(54, 162, 235, 1)");
    grad.addColorStop(1, "rgba(54, 162, 235, 0.4)");

    if (graficoDia) graficoDia.destroy();

    graficoDia = new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [
                {
                    label: "",
                    data: totals,
                    backgroundColor: grad,
                    borderRadius: 14,
                    borderSkipped: false,
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `R$ ${ctx.raw.toFixed(2)}`
                    }
                }
            },

            // ⭐ LIMPEZA TOTAL DO GRÁFICO ⭐
            scales: {
                x: {
                    ticks: { color: "#000", font: { size: 12 } },
                    grid: { display: false },   // ❌ remove linhas verticais
                    border: { display: false }  // ❌ remove borda eixo X
                },
                y: {
                    beginAtZero: true,
                    ticks: { display: false },  // ❌ remove números
                    grid: { display: false },   // ❌ remove linhas horizontais
                    border: { display: false }  // ❌ remove borda eixo Y
                }
            },

            layout: {
                padding: { top: 50 }
            }
        }
    });
}

// Carrega o dia atual automaticamente
window.onload = () => {
    const hoje = new Date().toISOString().split("T")[0];

    if (document.getElementById("data-dia")) {
        document.getElementById("data-dia").value = hoje;
    }

    carregarGraficoDia();
};
</script>
</body>
</html>